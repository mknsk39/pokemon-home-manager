# 画面構成

## ルーティングと認証フロー

全画面に対してグローバルミドルウェア (`middleware/auth.global.ts`) が適用される。

| 条件 | 遷移先 |
| --- | --- |
| 未認証ユーザーが `/auth` 以外にアクセス | `/auth` へリダイレクト |
| 認証済みユーザーが `/auth` にアクセス | `/` へリダイレクト |

### 認証フロー

```
初回アクセス
  │
  ├─ 未認証 ──→ /auth（認証画面）
  │                │
  │                ├─ Google ログイン成功 ──→ /（ホーム）
  │                └─ ログイン失敗 ──→ エラー表示（画面遷移なし）
  │
  └─ 認証済み ──→ /（ホーム）

ログアウト（ヘッダーメニュー）
  └─ /auth へ遷移
```

---

## 画面一覧

### 認証画面 (`/auth`)

- パス: `/auth`
- レイアウト: ヘッダーなし
- Google ログインボタンを中央に配置
- ログイン中はローディング状態を表示
- 失敗時はエラーメッセージを表示
- ログイン成功後、自動的に `/` へ遷移

### ホーム画面 / ポケモン一覧 (`/`)

- パス: `/`
- レイアウト: 共通ヘッダーあり
- コンポーネント: `PokemonListView` (Organism) + `PokemonCard` (Molecule)

#### 表示切り替え（種別 / すがた）

- ヘッダー右側にセグメンテッドボタン（`v-btn-toggle`）を配置
- 「種別」「すがた」の 2 モードを切り替え可能
  - **種別モード**: `PokemonSpecies` の一覧（1025 件）を表示
  - **すがたモード**: `PokemonForm` の一覧（1591 件）を表示
- モード切り替え時は表示件数をリセットし、先頭から再表示
- すがたモードでの表示名ルール：
  - 種族名を常にメインテキストとして表示
  - `formName` がある場合はサブテキストとして1行で追加表示（超過時は省略、ホバーでツールチップ表示）
  - `formName` が無い場合もサブテキスト領域の高さを確保し、カード高さを統一

#### 一覧表示

- マスターデータから全ポケモン種族を取得し、グリッド形式でカード（`PokemonCard`）表示
- 各カードにはポケボールアイコン、図鑑No、ポケモン名を表示
- グリッドは `minmax(224px, 1fr)` のレスポンシブ対応

#### 無限スクロール

- `BaseInfiniteScroll`（`v-infinite-scroll` ラッパー）を使用
- 初期表示は 50 件、スクロールで 50 件ずつ追加読み込み
- 全件表示完了後はローディングを終了

#### スクロールトップボタン

- 画面を 200px 以上スクロールすると、右下に FAB（丸型ボタン）が出現
- ボタン押下でスムーズにページ先頭へ戻る
- フェードイン/アウトのトランジション付き
- ロジックは `useScrollToTop` Composable に分離

#### 検索 & フィルタリング

- コンポーネント: `PokemonSearchFilter` (Molecule)
- 検索バーとフィルターパネルをヘッダーとグリッドの間に配置

##### 検索バー

- 常時表示。名前はあいまい一致、図鑑No.は前方一致
- `BaseTextField` を使用（clearable、prependInnerIcon: `mdi-magnify`）

##### フィルターパネル

- トグルボタンで開閉。アクティブ時はボタンにバッジ表示
- チップグループ（`BaseChipGroup` + `BaseChip`）による複数選択
  - **世代**: 1〜9（デフォルト姿の `generation` で判定）
  - **リージョン**（すがたモード時のみ表示）: アローラ / ガラル / ヒスイ / パルデア（`region` の完全一致）
  - **特殊フォーム**（すがたモード時のみ表示）: メガシンカ / キョダイマックス / ゲンシカイキ
  - **せいべつ**（すがたモード時のみ表示）: オス / メス / 性別なし（`genderType` の完全一致。`both` はいずれにもマッチしない）
- リセットボタンで全条件クリア

##### フィルタリングロジック

- 複数条件の組み合わせ: AND 結合（検索テキスト AND 世代 AND リージョン AND 特殊フォーム AND せいべつ）
- 同カテゴリ内の複数選択: OR 結合（世代1 OR 世代2 → どちらかに該当すれば表示）
- ロジックは `usePokemonFilter` Composable + `domain/pokemonFilter.ts` に分離

##### 結果件数表示

- フィルター適用中のみ「全X件中 Y件」を表示

#### 所持管理

ログインユーザーごとに各姿（PokemonForm）の所持・未所持をトグル管理できる。

##### すがたモード

- PokemonCard をタップ → そのフォームの所持/未所持をトグル
- 所持済み: カード左端にプライマリカラーのボーダー表示 + ポケボールアイコンがプライマリカラー
- 未所持: ボーダーなし + ポケボールアイコンが薄いグレー

##### 種別モード

- PokemonCard に所持数/全フォーム数を表示（例: `2/5`）
- 全フォーム所持: 所持済みスタイル適用（左ボーダー + アイコン色変化）
- 一部所持・未所持: デフォルト表示
- カードタップ: 種別モードではトグルしない（表示のみ）

##### 保存タイミングと楽観的UI更新

- カードタップのたびに Firestore へ即座に書き込み（`arrayUnion` / `arrayRemove`）
- **楽観的UI更新**: Firestore の応答を待たずにローカル state を先に反映し、UIの即時応答性を確保
  - 連打しても `isOwned` の判定が常に最新のローカル状態に基づくため、意図通りにトグルされる
  - Firestore 書き込みが失敗した場合はローカル state をロールバック（元に戻す）
- `onSnapshot` リスナーにより、他端末からの変更もリアルタイムに反映される

##### 所持フィルター

- `PokemonSearchFilter` のフィルターパネルに「所持状態」セクションを追加（ログイン時のみ表示）
- チップ: 「所持のみ」「未所持のみ」（何も選択しなければ「すべて」）
- すがたモード: formId が ownedFormIds に含まれるかで判定
- 種別モード: 「所持のみ」= 全フォーム所持の種族 / 「未所持のみ」= 1つも所持していない種族

#### 将来拡張（未実装）

- フィルタ：ソフト別、姿違いのみ
- グリッド/リスト表示の切り替え

### ダッシュボード (`/dashboard`)

- パス: `/dashboard`
- レイアウト: 共通ヘッダーあり
- コンポーネント: `DashboardView` (Organism) + `AchievementSummary` (Molecule) + `DonutChart` (Atom)

#### 全体達成率

- すがた（フォーム）単位で達成率を計算: 所持フォーム数 / 全フォーム数 (1591)
- SVG ベースのドーナツチャートで可視化（ゼロ依存）
- チャート中央に達成率（%、小数点1桁）を表示
- チャート下部に「X / Y 匹」テキストを表示

#### ナビゲーション

- AppHeader のブランド領域右側にアイコンボタンを配置
- Home (`/`) にいる時: `mdi-chart-donut` アイコンで `/dashboard` に遷移
- Dashboard (`/dashboard`) にいる時: `mdi-format-list-bulleted` アイコンで `/` に遷移

#### 将来拡張（未実装）

- ソフト別達成率をプログレスバーで一覧表示
- 「Rotom Report（SNS 共有用画像）」の生成機能

---

## 共通レイアウト

### 共通ヘッダー

- 認証画面（`/auth`）では非表示
- ブランドアイコン + アプリ名を左側に表示
- 認証済みの場合、右側にユーザーメニューを表示
  - アバター画像（未設定時はフォールバックアイコン）
  - メニュー内にログアウトボタン
